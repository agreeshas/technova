<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0a0a0a">
<title>ğŸš©ğŸ’š Relationship Flag Detector</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,600;1,400&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #0a0a0a;
  --surface: #f0eff3;
  --surface2: #1a1a1a;
  --border: rgba(255,255,255,0.07);
  --text: #dcd2bd;
  --muted: #555;
  --soft: #999;
  --red: #e53e3e;
  --red-glow: rgba(229,62,62,0.11);
  --red-border: rgba(192, 146, 146, 0.22);
  --red-text: #fc8181;
  --green: #38a169;
  --green-glow: rgba(62, 206, 129, 0.11);
  --green-border: rgba(56,161,105,0.22);
  --green-text: #68d391;
  --gold: #d69e2e;
  --gold-text: #f6e05e;
  --purple: #9f7aea;
  --purple-glow: rgba(159,122,234,0.12);
  --purple-border: rgba(159,122,234,0.25);
}

*{box-sizing:border-box;margin:0;padding:0;}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content:'';
  position:fixed;
  inset:0;
  background:
    radial-gradient(ellipse 70% 40% at 15% 5%,  rgba(172, 37, 168, 0.055) 0%, transparent 65%),
    radial-gradient(ellipse 50% 50% at 85% 90%, rgba(56,161,105,0.045) 0%, transparent 60%),
    radial-gradient(ellipse 40% 30% at 50% 50%, rgba(159,122,234,0.025) 0%, transparent 70%);
  pointer-events:none;
  z-index:0;
}

.app {
  position:relative;
  z-index:1;
  max-width:720px;
  margin:0 auto;
  padding:36px 18px 80px;
}

/* â”€â”€ HEADER â”€â”€ */
.header {
  text-align:center;
  margin-bottom:48px;
  animation:slideDown 0.8s ease both;
}

.flag-icons {
  font-size:42px;
  letter-spacing:10px;
  margin-bottom:16px;
  display:block;
  animation:floatPulse 4s ease infinite;
}

@keyframes floatPulse {
  0%,100%{transform:translateY(0); filter:drop-shadow(0 0 10px rgba(229,62,62,0.3));}
  50%{transform:translateY(-4px); filter:drop-shadow(0 0 22px rgba(229,62,62,0.55));}
}

h1 {
  font-family:'Cormorant Garamond',serif;
  font-size:clamp(28px,8vw,52px);
  font-weight:600;
  line-height:1.1;
  margin-bottom:10px;
}
.h1-red   {color:var(--red-text);}
.h1-amp   {color:var(--muted);font-style:italic;font-weight:400;margin:0 8px;}
.h1-green {color:var(--green-text);}

.header-sub {
  font-size:11px;
  letter-spacing:0.3em;
  color:var(--muted);
  text-transform:uppercase;
  margin-bottom:12px;
}

.header-desc {
  font-family:'Cormorant Garamond',serif;
  font-style:italic;
  font-size:16px;
  color:var(--soft);
  max-width:480px;
  margin:0 auto;
  line-height:1.75;
}

/* â”€â”€ INPUT MODE TABS â”€â”€ */
.input-tabs {
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:8px;
  margin-bottom:16px;
}

.input-tab {
  padding:14px 8px;
  border-radius:14px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  font-family:'Outfit',sans-serif;
  font-size:12px;
  font-weight:500;
  cursor:pointer;
  transition:all 0.2s;
  text-align:center;
  line-height:1.5;
}

.input-tab:hover {border-color:rgba(255,255,255,0.14);color:var(--soft);}

.input-tab .tab-icon {font-size:22px;display:block;margin-bottom:4px;}
.input-tab .tab-label{display:block;letter-spacing:0.05em;}
.input-tab .tab-sub  {display:block;font-size:10px;color:var(--muted);margin-top:2px;}

.input-tab.tab-text.active   {background:rgba(214,158,46,0.1); border-color:rgba(214,158,46,0.35);color:var(--gold-text);}
.input-tab.tab-record.active {background:rgba(229,62,62,0.1);  border-color:var(--red-border);    color:var(--red-text);}
.input-tab.tab-upload.active {background:var(--purple-glow);   border-color:var(--purple-border); color:var(--purple);}

/* â”€â”€ CARDS â”€â”€ */
.card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:20px;
  padding:24px;
  margin-bottom:16px;
  animation:fadeUp 0.4s ease both;
}

.card-label {
  font-size:10px;
  letter-spacing:0.3em;
  color:var(--muted);
  text-transform:uppercase;
  margin-bottom:14px;
}

/* â”€â”€ ANALYSIS MODE TABS â”€â”€ */
.mode-row {
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:8px;
}

.mode-btn {
  padding:11px 8px;
  border-radius:12px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  font-family:'Outfit',sans-serif;
  font-size:12px;
  cursor:pointer;
  transition:all 0.2s;
  text-align:center;
}
.mode-btn:hover{border-color:rgba(255,255,255,0.14);color:var(--soft);}
.mode-btn.active-both  {background:rgba(214,158,46,0.1); border-color:rgba(214,158,46,0.35);color:var(--gold-text);}
.mode-btn.active-red   {background:var(--red-glow);       border-color:var(--red-border);    color:var(--red-text);}
.mode-btn.active-green {background:var(--green-glow);     border-color:var(--green-border);  color:var(--green-text);}

/* â”€â”€ INPUTS â”€â”€ */
input,textarea {
  width:100%;
  background:rgba(0,0,0,0.45);
  border:1px solid var(--border);
  border-radius:10px;
  color:var(--text);
  font-family:'Outfit',sans-serif;
  font-size:14px;
  padding:13px 16px;
  outline:none;
  transition:border-color 0.2s,box-shadow 0.2s;
}
input:focus,textarea:focus{border-color:rgba(214,158,46,0.4);box-shadow:0 0 0 3px rgba(214,158,46,0.07);}
input::placeholder,textarea::placeholder{color:#333;}
textarea{min-height:150px;resize:vertical;line-height:1.75;}

/* â”€â”€ EXAMPLES â”€â”€ */
.examples{display:flex;flex-wrap:wrap;gap:7px;margin-top:12px;}
.ex-label{font-size:10px;color:var(--muted);align-self:center;letter-spacing:0.15em;text-transform:uppercase;}
.ex-btn {
  font-size:11px;padding:5px 13px;border-radius:20px;
  border:1px solid var(--border);background:var(--surface2);
  color:var(--soft);cursor:pointer;font-family:'Outfit',sans-serif;transition:all 0.2s;
}
.ex-btn:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}

/* â”€â”€ RECORD PANEL â”€â”€ */
.record-panel {
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:32px 20px;
  gap:20px;
}

.record-btn {
  width:88px;height:88px;
  border-radius:50%;
  border:none;
  cursor:pointer;
  font-size:34px;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.3s;
  position:relative;
}

.record-btn.idle {
  background:linear-gradient(135deg,#742a2a,#e53e3e);
  box-shadow:0 4px 24px rgba(229,62,62,0.35);
}
.record-btn.idle:hover{transform:scale(1.06);box-shadow:0 8px 36px rgba(229,62,62,0.5);}

.record-btn.recording {
  background:linear-gradient(135deg,#c53030,#fc8181);
  animation:recordPulse 1.2s ease infinite;
}

@keyframes recordPulse {
  0%,100%{box-shadow:0 0 0 0 rgba(229,62,62,0.5);}
  50%    {box-shadow:0 0 0 18px rgba(229,62,62,0);}
}

.record-btn.has-recording {
  background:linear-gradient(135deg,#276749,#38a169);
  box-shadow:0 4px 24px rgba(56,161,105,0.35);
}

.record-status {
  font-size:14px;
  color:var(--soft);
  text-align:center;
  line-height:1.6;
}

.record-status.active{color:var(--red-text);font-weight:500;}
.record-status.done  {color:var(--green-text);}

/* Waveform visualizer */
.waveform {
  display:flex;
  align-items:center;
  gap:3px;
  height:36px;
  opacity:0;
  transition:opacity 0.3s;
}
.waveform.visible{opacity:1;}
.wave-bar {
  width:3px;
  border-radius:2px;
  background:var(--red-text);
  animation:waveBounce 0.8s ease infinite;
  min-height:4px;
}
.wave-bar:nth-child(1){animation-delay:0s;   height:14px;}
.wave-bar:nth-child(2){animation-delay:0.1s; height:22px;}
.wave-bar:nth-child(3){animation-delay:0.2s; height:30px;}
.wave-bar:nth-child(4){animation-delay:0.3s; height:20px;}
.wave-bar:nth-child(5){animation-delay:0.15s;height:26px;}
.wave-bar:nth-child(6){animation-delay:0.25s;height:18px;}
.wave-bar:nth-child(7){animation-delay:0.05s;height:28px;}
.wave-bar:nth-child(8){animation-delay:0.2s; height:16px;}
.wave-bar:nth-child(9){animation-delay:0.1s; height:24px;}

@keyframes waveBounce {
  0%,100%{transform:scaleY(1);}
  50%    {transform:scaleY(0.35);}
}

.timer {
  font-family:'Cormorant Garamond',serif;
  font-size:28px;
  color:var(--red-text);
  letter-spacing:0.1em;
  min-width:80px;
  text-align:center;
}

.audio-preview {
  width:100%;
  margin-top:4px;
  border-radius:8px;
  background:rgba(0,0,0,0.3);
}
audio{width:100%;border-radius:8px;outline:none;}

/* â”€â”€ UPLOAD PANEL â”€â”€ */
.upload-zone {
  border:2px dashed rgba(159,122,234,0.3);
  border-radius:16px;
  padding:40px 20px;
  text-align:center;
  cursor:pointer;
  transition:all 0.3s;
  background:rgba(159,122,234,0.03);
  position:relative;
}

.upload-zone:hover,
.upload-zone.dragover {
  border-color:rgba(159,122,234,0.6);
  background:rgba(159,122,234,0.07);
}

.upload-zone input[type="file"] {
  position:absolute;inset:0;
  opacity:0;cursor:pointer;
  width:100%;height:100%;
  padding:0;border:none;background:none;
}

.upload-icon {font-size:40px;margin-bottom:12px;display:block;}
.upload-title{font-size:15px;color:var(--text);margin-bottom:6px;font-weight:500;}
.upload-sub  {font-size:12px;color:var(--muted);line-height:1.6;}
.upload-formats{font-size:11px;color:rgba(159,122,234,0.7);margin-top:8px;letter-spacing:0.1em;}

.file-selected {
  background:var(--purple-glow);
  border:1px solid var(--purple-border);
  border-radius:12px;
  padding:16px 18px;
  display:flex;
  align-items:center;
  gap:14px;
  margin-top:12px;
}
.file-icon  {font-size:28px;flex-shrink:0;}
.file-name  {font-size:13px;color:var(--purple);font-weight:500;word-break:break-all;}
.file-size  {font-size:11px;color:var(--muted);margin-top:3px;}
.file-clear {
  margin-left:auto;font-size:18px;
  color:var(--muted);cursor:pointer;flex-shrink:0;
  transition:color 0.2s;background:none;border:none;
}
.file-clear:hover{color:var(--text);}

/* â”€â”€ TRANSCRIPT BOX â”€â”€ */
.transcript-box {
  background:rgba(159,122,234,0.06);
  border:1px solid var(--purple-border);
  border-radius:12px;
  padding:18px;
  margin-bottom:16px;
  animation:fadeUp 0.4s ease both;
}
.transcript-box .card-label{color:rgba(159,122,234,0.7);margin-bottom:10px;}
.transcript-text {
  font-size:13px;
  color:#c4bdb5;
  line-height:1.8;
  font-family:'Cormorant Garamond',serif;
  font-style:italic;
  max-height:140px;
  overflow-y:auto;
}

/* â”€â”€ BUTTONS â”€â”€ */
.btn-analyze {
  width:100%;
  padding:16px;
  border-radius:14px;
  border:none;
  font-family:'Outfit',sans-serif;
  font-size:13px;
  font-weight:600;
  letter-spacing:0.2em;
  text-transform:uppercase;
  cursor:pointer;
  transition:all 0.3s;
  margin-bottom:22px;
}
.btn-analyze.ready {
  background:linear-gradient(135deg,#276749 0%,#1b4332 45%,#742a2a 100%);
  color:#fff;
  box-shadow:0 4px 28px rgba(56,161,105,0.18),0 4px 28px rgba(229,62,62,0.12);
}
.btn-analyze.ready:hover {
  transform:translateY(-2px);
  box-shadow:0 8px 40px rgba(56,161,105,0.28),0 8px 40px rgba(229,62,62,0.2);
}
.btn-analyze:disabled{background:var(--surface2);color:var(--muted);cursor:not-allowed;}

.btn-small{
  padding:9px 20px;border-radius:10px;
  border:1px solid var(--border);background:transparent;
  color:var(--muted);font-family:'Outfit',sans-serif;
  font-size:12px;cursor:pointer;transition:all 0.2s;
  margin-top:18px;display:inline-block;
}
.btn-small:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}

/* â”€â”€ SETUP CARD â”€â”€ */
.setup-card {
  background:var(--surface);
  border:1px solid rgba(214,158,46,0.2);
  border-radius:20px;
  padding:28px;
  margin-bottom:20px;
  animation:fadeUp 0.5s ease both;
}
.setup-card h3{font-size:11px;letter-spacing:0.25em;text-transform:uppercase;color:var(--gold-text);margin-bottom:20px;}
.setup-step{display:flex;gap:14px;align-items:flex-start;margin-bottom:14px;}
.step-num{
  width:28px;height:28px;border-radius:50%;
  background:rgba(214,158,46,0.12);border:1px solid rgba(214,158,46,0.3);
  color:var(--gold-text);font-size:12px;font-weight:600;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.step-text{font-size:14px;color:var(--soft);line-height:1.6;padding-top:4px;}
.step-text a{color:var(--gold-text);text-decoration:none;border-bottom:1px solid rgba(246,224,94,0.3);}
.step-text strong{color:var(--text);}
.key-row{display:flex;gap:10px;margin-top:4px;}

/* â”€â”€ LOADING â”€â”€ */
.loading-wrap{text-align:center;padding:70px 20px;animation:fadeUp 0.4s ease both;}
.spin-emoji{font-size:46px;display:inline-block;animation:spinBounce 1.4s ease infinite;margin-bottom:22px;}
@keyframes spinBounce{0%,100%{transform:scale(1) rotate(0deg);}50%{transform:scale(1.15) rotate(180deg);}}
.loading-msg{font-family:'Cormorant Garamond',serif;font-style:italic;font-size:18px;color:var(--soft);margin-bottom:8px;}
.loading-sub{font-size:12px;color:var(--muted);}
.loading-steps{margin-top:20px;display:flex;flex-direction:column;gap:8px;}
.loading-step{font-size:12px;color:var(--muted);opacity:0;transition:opacity 0.5s;text-align:center;}
.loading-step.show{opacity:1;color:var(--soft);}

/* â”€â”€ ERROR â”€â”€ */
.error-box{
  background:rgba(229,62,62,0.08);border:1px solid rgba(229,62,62,0.25);
  border-radius:10px;padding:14px 18px;color:var(--red-text);
  font-size:13px;margin-bottom:16px;line-height:1.6;
}

/* â”€â”€ RESULTS â”€â”€ */
.health-banner{
  border-radius:20px;padding:28px;margin-bottom:16px;
  animation:fadeUp 0.5s ease both;
  border:1px solid rgba(255,255,255,0.07);
  background:var(--surface);
}
.health-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;margin-bottom:18px;}
.score-label{font-size:10px;letter-spacing:0.3em;color:var(--muted);text-transform:uppercase;margin-bottom:6px;}
.score-num{font-family:'Cormorant Garamond',serif;font-size:clamp(48px,12vw,70px);font-weight:600;line-height:1;}
.grade-box{text-align:right;}
.grade-circle{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;border:2px solid currentColor;margin-left:auto;}
.grade-label{font-size:10px;letter-spacing:0.2em;text-transform:uppercase;margin-top:6px;color:var(--muted);}
.meter-labels{display:flex;justify-content:space-between;margin-bottom:8px;}
.meter-label{font-size:11px;letter-spacing:0.1em;text-transform:uppercase;font-weight:600;}
.meter-label.red{color:var(--red-text);}
.meter-label.green{color:var(--green-text);}
.split-meter{display:flex;height:8px;border-radius:4px;overflow:hidden;background:rgba(255,255,255,0.04);margin-bottom:20px;}
.bar-red{background:linear-gradient(90deg,#742a2a,#e53e3e);border-radius:4px 0 0 4px;transition:width 1.2s cubic-bezier(0.4,0,0.2,1);flex-shrink:0;}
.bar-green{background:linear-gradient(90deg,#276749,#38a169);border-radius:0 4px 4px 0;transition:width 1.2s cubic-bezier(0.4,0,0.2,1);flex-shrink:0;margin-left:auto;}
.health-summary{font-family:'Cormorant Garamond',serif;font-style:italic;font-size:15px;line-height:1.85;color:#1a1a1a;}

.flags-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;}
.flags-col{border-radius:16px;padding:20px;animation:fadeUp 0.4s ease both;}
.flags-col.col-red  {background:var(--red-glow);  border:1px solid var(--red-border);}
.flags-col.col-green{background:var(--green-glow);border:1px solid var(--green-border);}
.col-head{display:flex;align-items:center;gap:8px;margin-bottom:14px;}
.col-icon{font-size:18px;}
.col-title{font-size:11px;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;}
.col-red   .col-title{color:var(--red-text);}
.col-green .col-title{color:var(--green-text);}
.flag-item{padding:12px 14px;border-radius:10px;margin-bottom:10px;}
.flag-item:last-child{margin-bottom:0;}
.col-red   .flag-item{background:rgba(229,62,62,0.07); border:1px solid rgba(229,62,62,0.13);}
.col-green .flag-item{background:rgba(56,161,105,0.07);border:1px solid rgba(56,161,105,0.13);}
.flag-type{font-size:10px;font-weight:600;letter-spacing:0.15em;text-transform:uppercase;margin-bottom:5px;}
.col-red   .flag-type{color:var(--red-text);}
.col-green .flag-type{color:var(--green-text);}
.flag-quote{font-size:12px;color:var(--muted);font-style:italic;line-height:1.5;margin-bottom:6px;padding:5px 8px;border-radius:5px;border-left:2px solid currentColor;}
.col-red   .flag-quote{border-color:rgba(229,62,62,0.35);background:rgba(229,62,62,0.05);}
.col-green .flag-quote{border-color:rgba(56,161,105,0.35);background:rgba(56,161,105,0.05);}
.flag-explain{font-size:12px;color:var(--soft);line-height:1.65;}
.no-flags{font-size:13px;color:var(--muted);font-style:italic;font-family:'Cormorant Garamond',serif;text-align:center;padding:16px 0;}

.affirm-card{background:rgba(214,158,46,0.05);border:1px solid rgba(214,158,46,0.15);border-radius:16px;padding:22px;margin-bottom:16px;animation:fadeUp 0.4s ease both 0.1s;}
.affirm-card p{font-family:'Cormorant Garamond',serif;font-style:italic;font-size:15px;line-height:1.85;color:#d4ccc4;}
.actions-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:22px;margin-bottom:16px;animation:fadeUp 0.4s ease both 0.15s;}
.action-item{display:flex;gap:12px;align-items:flex-start;margin-bottom:10px;}
.action-item:last-child{margin-bottom:0;}
.action-arrow{color:var(--gold-text);font-size:12px;margin-top:3px;flex-shrink:0;}
.action-text{font-size:13px;color:var(--soft);line-height:1.65;}
.resources-card{background:var(--red-glow);border:1px solid var(--red-border);border-radius:16px;padding:22px;margin-bottom:16px;animation:fadeUp 0.4s ease both 0.2s;}
.resources-card .card-label{color:rgba(252,129,129,0.7);}
.resource-line{font-size:13px;color:#c4bdb5;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);line-height:1.6;}
.resource-line:last-child{border-bottom:none;}

.privacy-note{text-align:center;font-size:11px;color:#64575e;margin-bottom:20px;margin-top:-10px;}
.footer{text-align:center;margin-top:60px;font-size:11px;color:#a7569a;line-height:2.2;}

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes slideDown{from{opacity:0;transform:translateY(-24px);}to{opacity:1;transform:translateY(0);}}
@keyframes fadeUp   {from{opacity:0;transform:translateY(18px);}  to{opacity:1;transform:translateY(0);}}

/* â”€â”€ MOBILE â”€â”€ */
@media(max-width:540px){
  .flags-grid{grid-template-columns:1fr;}
  .app{padding:24px 14px 60px;}
  .card,.setup-card{padding:18px;}
  .health-banner{padding:20px;}
  .key-row{flex-direction:column;}
  .record-btn{width:74px;height:74px;font-size:28px;}
}
</style>
</head>
<body>
<div class="app">

  <div class="header">
    <span class="flag-icons">ğŸš© ğŸ’š</span>
    <h1>
      <span class="h1-red">Red Flag</span>
      <span class="h1-amp">&</span>
      <span class="h1-green">Green Flag</span>
    </h1>
    <p class="header-sub">Relationship Health Detector</p>
    <p class="header-desc">
      Paste text, record a voice note, or upload an audio file â€”
      our AI detects manipulation and healthy love patterns instantly.
    </p>
  </div>

  <div id="app-root"></div>

  <div class="footer">
    Relationship Flag Detector â€” awareness tool only.<br>
    Not a substitute for professional support.<br>
    If you are in danger, call emergency services immediately.<br><br>
    Built with â¤ï¸ at Hackathon 2026
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const state = {
  screen:      localStorage.getItem('groq_key') ? 'analyze' : 'setup',
  apiKey:      localStorage.getItem('groq_key') || '',
  inputMode:   'text',     // 'text' | 'record' | 'upload'
  analyzeMode: 'both',     // 'both' | 'red' | 'green'
  textInput:   '',
  audioBlob:   null,       // recorded audio
  audioFile:   null,       // uploaded audio file
  audioURL:    null,       // for playback
  transcript:  '',         // text from speech-to-text
  result:      null,
  error:       '',

  // Recording state
  isRecording: false,
  recSeconds:  0,
  recInterval: null,
  mediaRecorder: null,
  audioChunks: [],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAMPLE TEXTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SAMPLES = [
  `"Baby I'm sorry I got upset. I love you so much it drives me crazy. I support everything you do â€” but you should spend less time with Maya, she's a bad influence. I just want us to be closer. You're everything to me."`,
  `"Hey, I noticed you seemed quiet and wanted to check in â€” how are you? No pressure. I know I messed up last week and you were completely right. I want to do better. You don't have to make yourself small for me."`,
  `"You went out AGAIN? If you really loved me you'd WANT to be with me. I gave up so much for this relationship. Go have fun â€” don't worry about me sitting here alone. I don't get why you need friends when you have me."`,
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SYSTEM PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SYSTEM_PROMPT = `You are a compassionate relationship health analyst. Analyze the given text (which may be a transcription of a voice note or call) for BOTH red flags and green flags.

RED FLAG types:
- GASLIGHTING: denying reality, "you're imagining things"
- CONTROL_AS_CARE: possessiveness framed as love
- GUILT_TRIPPING: blame-shifting, "look what you made me do"
- ISOLATION: cutting off friends/family
- LOVE_BOMBING: excessive flattery used to manipulate
- EMOTIONAL_PRESSURE: ultimatums, threats
- POSSESSIVENESS: jealousy, tracking, demanding whereabouts
- DISRESPECT: contempt, put-downs, dismissing feelings

GREEN FLAG types:
- RESPECT: genuine respectful treatment
- HEALTHY_COMMUNICATION: open, honest, non-defensive dialogue
- EMOTIONAL_SUPPORT: being present, checking in
- TRUST: showing or building trust
- AUTONOMY: respecting independence and friendships
- EMPATHY: genuine understanding and compassion
- ACCOUNTABILITY: owning mistakes without deflection
- ENCOURAGEMENT: uplifting, celebrating partner

Respond ONLY in valid JSON (no markdown, no code blocks):
{
  "health_score": <0-100>,
  "grade": "<TOXIC|CONCERNING|MIXED|GOOD|EXCELLENT>",
  "red_flag_count": <number>,
  "green_flag_count": <number>,
  "red_flags": [{"type":"","label":"","quote":"","explanation":""}],
  "green_flags": [{"type":"","label":"","quote":"","explanation":""}],
  "overall_summary": "<2-3 warm honest sentences>",
  "what_to_watch": ["<2-4 actionable items>"],
  "you_deserve": "<one powerful affirming statement>",
  "resources": ["National DV Hotline: 1-800-799-7233","Crisis Text: Text HOME to 741741","loveisrespect.org","iCall India: icallhelpline.org"]
}`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const root = document.getElementById('app-root');
  if      (state.screen === 'setup')   root.innerHTML = renderSetup();
  else if (state.screen === 'analyze') root.innerHTML = renderAnalyze();
  else if (state.screen === 'loading') root.innerHTML = renderLoading();
  else if (state.screen === 'result')  root.innerHTML = renderResult();
  attachEvents();
}

// â”€â”€ SETUP SCREEN â”€â”€
function renderSetup() {
  return `
  <div class="setup-card">
    <h3>âš™ï¸ Quick Setup â€” Get Your Free Groq API Key</h3>
    <div class="setup-step">
      <div class="step-num">1</div>
      <div class="step-text">Go to <a href="https://console.groq.com" target="_blank">console.groq.com</a> â†’ Sign up free (Google/GitHub)</div>
    </div>
    <div class="setup-step">
      <div class="step-num">2</div>
      <div class="step-text">Click <strong>"API Keys"</strong> in sidebar â†’ <strong>"Create API Key"</strong> â†’ Copy it</div>
    </div>
    <div class="setup-step">
      <div class="step-num">3</div>
      <div class="step-text">Paste your key below (starts with <code style="color:var(--gold-text);font-size:12px">gsk_...</code>)</div>
    </div>
    <div class="key-row">
      <input type="password" id="apiKeyInput" placeholder="gsk_xxxxxxxxxxxxxxxxxxxxxxxx" value="${esc(state.apiKey)}">
      <button class="btn-analyze ready" style="width:auto;padding:12px 22px;margin:0;font-size:12px" onclick="saveKey()">Save â†’</button>
    </div>
    <p style="font-size:11px;color:var(--muted);margin-top:14px;line-height:1.7">
      ğŸ”’ Stored only in your browser â€” we never see it. Free tier: 14,400 requests/day.
    </p>
  </div>`;
}

// â”€â”€ ANALYZE SCREEN â”€â”€
function renderAnalyze() {
  const inputTabs = [
    { id:'text',   icon:'ğŸ“', label:'Text',       sub:'Paste message',    cls:'tab-text'   },
    { id:'record', icon:'ğŸ¤', label:'Record',      sub:'Use microphone',   cls:'tab-record' },
    { id:'upload', icon:'ğŸ“', label:'Upload',      sub:'Audio file',       cls:'tab-upload' },
  ];
  const modes = [
    { id:'both',  label:'ğŸš©ğŸ’š Both',     cls: state.analyzeMode==='both'  ? 'active-both'  : '' },
    { id:'red',   label:'ğŸš© Red Only',   cls: state.analyzeMode==='red'   ? 'active-red'   : '' },
    { id:'green', label:'ğŸ’š Green Only', cls: state.analyzeMode==='green' ? 'active-green' : '' },
  ];

  // Determine if ready to analyze
  const canAnalyze =
    (state.inputMode === 'text'   && state.textInput.trim()) ||
    (state.inputMode === 'record' && state.audioBlob) ||
    (state.inputMode === 'upload' && state.audioFile);

  return `
  <!-- INPUT TYPE TABS -->
  <div class="input-tabs">
    ${inputTabs.map(t => `
      <button class="input-tab ${t.cls} ${state.inputMode === t.id ? 'active' : ''}"
              onclick="setInputMode('${t.id}')">
        <span class="tab-icon">${t.icon}</span>
        <span class="tab-label">${t.label}</span>
        <span class="tab-sub">${t.sub}</span>
      </button>
    `).join('')}
  </div>

  <!-- ANALYSIS MODE -->
  <div class="card">
    <div class="card-label">Detection Mode</div>
    <div class="mode-row">
      ${modes.map(m => `
        <button class="mode-btn ${m.cls}" onclick="setAnalyzeMode('${m.id}')">${m.label}</button>
      `).join('')}
    </div>
  </div>

  <!-- INPUT PANEL (changes based on tab) -->
  ${renderInputPanel()}

  <!-- ERROR -->
  ${state.error ? `<div class="error-box">âš ï¸ ${esc(state.error)}</div>` : ''}

  <!-- ANALYZE BUTTON -->
  <button class="btn-analyze ${canAnalyze ? 'ready' : ''}" onclick="startAnalysis()">
    ğŸ” Analyze Relationship Flags
  </button>

  <p class="privacy-note">ğŸ”’ Private & anonymous â€” no data stored anywhere.</p>

  <div style="text-align:right">
    <button class="btn-small" onclick="goSetup()">âš™ï¸ Change API Key</button>
  </div>`;
}

// â”€â”€ INPUT PANELS â”€â”€
function renderInputPanel() {
  if (state.inputMode === 'text')   return renderTextPanel();
  if (state.inputMode === 'record') return renderRecordPanel();
  if (state.inputMode === 'upload') return renderUploadPanel();
  return '';
}

function renderTextPanel() {
  return `
  <div class="card">
    <div class="card-label">Paste a message, conversation, or describe what happened</div>
    <textarea id="msgInput"
      placeholder="e.g. 'You're being too sensitive again. I only said that because I love you...'"
    >${esc(state.textInput)}</textarea>
    <div class="examples">
      <span class="ex-label">Try:</span>
      <button class="ex-btn" onclick="setSample(0)">Mixed signals</button>
      <button class="ex-btn" onclick="setSample(1)">Healthy love</button>
      <button class="ex-btn" onclick="setSample(2)">Control pattern</button>
      <button class="ex-btn" onclick="clearText()">Clear âœ•</button>
    </div>
  </div>`;
}

function renderRecordPanel() {
  const isRec   = state.isRecording;
  const hasRec  = !!state.audioBlob && !isRec;
  const btnCls  = isRec ? 'recording' : hasRec ? 'has-recording' : 'idle';
  const btnIcon = isRec ? 'â¹ï¸' : hasRec ? 'âœ…' : 'ğŸ¤';
  const statusTxt = isRec
    ? 'Recording... tap to stop'
    : hasRec
    ? 'Recording saved! Ready to analyze.'
    : 'Tap the mic to start recording';
  const statusCls = isRec ? 'active' : hasRec ? 'done' : '';
  const mins = String(Math.floor(state.recSeconds/60)).padStart(2,'0');
  const secs = String(state.recSeconds % 60).padStart(2,'0');

  return `
  <div class="card">
    <div class="card-label">ğŸ¤ Record Voice Note or Conversation</div>
    <div class="record-panel">

      <!-- Waveform bars (visible while recording) -->
      <div class="waveform ${isRec ? 'visible' : ''}">
        ${Array(9).fill('<div class="wave-bar"></div>').join('')}
      </div>

      <!-- Timer -->
      ${isRec ? `<div class="timer">${mins}:${secs}</div>` : ''}

      <!-- Record button -->
      <button class="record-btn ${btnCls}" onclick="toggleRecording()">
        ${btnIcon}
      </button>

      <!-- Status text -->
      <p class="record-status ${statusCls}">${statusTxt}</p>

      <!-- Audio playback (after recording) -->
      ${hasRec && state.audioURL ? `
        <div class="audio-preview">
          <audio controls src="${state.audioURL}"></audio>
        </div>
        <button class="btn-small" onclick="clearRecording()" style="margin-top:8px">
          ğŸ—‘ï¸ Record Again
        </button>
      ` : ''}
    </div>
  </div>`;
}

function renderUploadPanel() {
  return `
  <div class="card">
    <div class="card-label">ğŸ“ Upload Voice Note or Call Recording</div>

    ${!state.audioFile ? `
      <div class="upload-zone" id="uploadZone"
           ondragover="handleDragOver(event)"
           ondragleave="handleDragLeave(event)"
           ondrop="handleDrop(event)">
        <input type="file" id="audioFileInput"
               accept="audio/*,.mp3,.wav,.m4a,.ogg,.webm,.flac"
               onchange="handleFileSelect(event)">
        <span class="upload-icon">ğŸµ</span>
        <p class="upload-title">Drop your audio file here</p>
        <p class="upload-sub">or click to browse your files</p>
        <p class="upload-formats">MP3 â€¢ WAV â€¢ M4A â€¢ OGG â€¢ WEBM â€¢ FLAC</p>
      </div>
    ` : `
      <div class="file-selected">
        <span class="file-icon">ğŸµ</span>
        <div>
          <div class="file-name">${esc(state.audioFile.name)}</div>
          <div class="file-size">${(state.audioFile.size/1024/1024).toFixed(2)} MB</div>
        </div>
        <button class="file-clear" onclick="clearFile()">âœ•</button>
      </div>
      ${state.audioURL ? `
        <div style="margin-top:12px">
          <audio controls src="${state.audioURL}" style="width:100%;border-radius:8px;"></audio>
        </div>
      ` : ''}
    `}

    <p style="font-size:11px;color:var(--muted);margin-top:14px;line-height:1.7">
      ğŸ’¡ Works with WhatsApp voice notes, call recordings, video files (audio extracted).<br>
      Max file size: 25MB (Groq Whisper limit).
    </p>
  </div>`;
}

// â”€â”€ LOADING SCREEN â”€â”€
function renderLoading() {
  const isAudio = state.inputMode === 'record' || state.inputMode === 'upload';
  const steps = isAudio
    ? ['Receiving your audio...', 'Transcribing speech to text (Whisper AI)...', 'Detecting red & green flags...', 'Preparing your report...']
    : ['Reading the message...', 'Identifying patterns...', 'Detecting red & green flags...', 'Preparing your report...'];

  // Cascade step visibility
  steps.forEach((_, i) => {
    setTimeout(() => {
      const el = document.getElementById(`lstep${i}`);
      if (el) el.classList.add('show');
    }, i * 1800);
  });

  return `
  <div class="loading-wrap">
    <div class="spin-emoji">${isAudio ? 'ğŸ§' : 'ğŸ”'}</div>
    <p class="loading-msg">${isAudio ? 'Analyzing your audio...' : 'Analyzing your message...'}</p>
    <p class="loading-sub">Powered by Groq AI</p>
    <div class="loading-steps">
      ${steps.map((s,i) => `
        <div class="loading-step ${i===0?'show':''}" id="lstep${i}">
          ${i===0?'âŸ³':''} ${s}
        </div>
      `).join('')}
    </div>
  </div>`;
}

// â”€â”€ RESULT SCREEN â”€â”€
function renderResult() {
  const r = state.result;
  const score = r.health_score ?? 50;
  const grade = r.grade || 'MIXED';
  const gradeColors = {TOXIC:'#fc8181',CONCERNING:'#fbd38d',MIXED:'#f6e05e',GOOD:'#68d391',EXCELLENT:'#68d391'};
  const gradeEmojis = {TOXIC:'ğŸ’”',CONCERNING:'âš ï¸',MIXED:'âš–ï¸',GOOD:'ğŸ’›',EXCELLENT:'ğŸ’š'};
  const color = gradeColors[grade] || '#f6e05e';
  const emoji = gradeEmojis[grade] || 'âš–ï¸';
  const redW   = Math.min(88,(r.red_flag_count||0)*12);
  const greenW = Math.min(88,(r.green_flag_count||0)*12);

  let html = '';

  // Show transcript if audio was used
  if (state.transcript) {
    html += `
    <div class="transcript-box">
      <div class="card-label">ğŸ™ï¸ Transcription (what the AI heard)</div>
      <div class="transcript-text">${esc(state.transcript)}</div>
    </div>`;
  }

  // Health banner
  html += `
  <div class="health-banner">
    <div class="health-top">
      <div>
        <div class="score-label">Relationship Health Score</div>
        <div class="score-num" style="color:${color}">${score} <span style="font-size:22px;opacity:0.4">/100</span></div>
      </div>
      <div class="grade-box">
        <div class="grade-circle" style="color:${color}">${emoji}</div>
        <div class="grade-label">${grade}</div>
      </div>
    </div>
    <div class="meter-labels">
      <span class="meter-label red">ğŸš© ${r.red_flag_count||0} Red Flag${(r.red_flag_count||0)!==1?'s':''}</span>
      <span class="meter-label green">${r.green_flag_count||0} Green Flag${(r.green_flag_count||0)!==1?'s':''} ğŸ’š</span>
    </div>
    <div class="split-meter">
      <div class="bar-red"   id="barRed"   style="width:0%"></div>
      <div class="bar-green" id="barGreen" style="width:0%"></div>
    </div>
    <p class="health-summary">${esc(r.overall_summary||'')}</p>
  </div>`;

  // Flags grid
  html += `<div class="flags-grid">
    <div class="flags-col col-red">
      <div class="col-head"><span class="col-icon">ğŸš©</span><span class="col-title">Red Flags</span></div>
      ${r.red_flags&&r.red_flags.length>0
        ? r.red_flags.map(f=>`
          <div class="flag-item">
            <div class="flag-type">${esc(f.label||f.type||'')}</div>
            ${f.quote?`<div class="flag-quote">"${esc(f.quote)}"</div>`:''}
            <div class="flag-explain">${esc(f.explanation||'')}</div>
          </div>`).join('')
        : '<p class="no-flags">No red flags detected ğŸ‰</p>'}
    </div>
    <div class="flags-col col-green">
      <div class="col-head"><span class="col-icon">ğŸ’š</span><span class="col-title">Green Flags</span></div>
      ${r.green_flags&&r.green_flags.length>0
        ? r.green_flags.map(f=>`
          <div class="flag-item">
            <div class="flag-type">${esc(f.label||f.type||'')}</div>
            ${f.quote?`<div class="flag-quote">"${esc(f.quote)}"</div>`:''}
            <div class="flag-explain">${esc(f.explanation||'')}</div>
          </div>`).join('')
        : '<p class="no-flags">No green flags in this message.</p>'}
    </div>
  </div>`;

  if(r.you_deserve){html+=`<div class="affirm-card"><div class="card-label">ğŸ’› Remember This</div><p>${esc(r.you_deserve)}</p></div>`;}

  if(r.what_to_watch&&r.what_to_watch.length>0){
    html+=`<div class="actions-card"><div class="card-label">ğŸ’¡ What To Pay Attention To</div>${r.what_to_watch.map(i=>`<div class="action-item"><span class="action-arrow">â†’</span><span class="action-text">${esc(i)}</span></div>`).join('')}</div>`;
  }

  if(['TOXIC','CONCERNING','MIXED'].includes(grade)&&r.resources){
    html+=`<div class="resources-card"><div class="card-label">ğŸ†˜ Support Resources</div>${r.resources.map(r=>`<div class="resource-line">${esc(r)}</div>`).join('')}</div>`;
  }

  html+=`<button class="btn-small" onclick="resetApp()">â† Analyze Another</button>`;

  setTimeout(()=>{
    const br=document.getElementById('barRed');
    const bg=document.getElementById('barGreen');
    if(br) br.style.width=redW+'%';
    if(bg) bg.style.width=greenW+'%';
  },100);

  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECORDING LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function toggleRecording() {
  if (state.isRecording) {
    stopRecording();
  } else {
    await startRecording();
  }
}

async function startRecording() {
  try {
    // Ask browser for microphone permission
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    state.audioChunks  = [];
    state.mediaRecorder = new MediaRecorder(stream);
    state.isRecording  = true;
    state.recSeconds   = 0;
    state.audioBlob    = null;
    state.audioURL     = null;

    // Collect audio data
    state.mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) state.audioChunks.push(e.data);
    };

    // When recording stops, build the blob
    state.mediaRecorder.onstop = () => {
      state.audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
      state.audioURL  = URL.createObjectURL(state.audioBlob);
      // Stop all mic tracks
      stream.getTracks().forEach(t => t.stop());
      render();
    };

    state.mediaRecorder.start(100); // Collect data every 100ms

    // Timer
    state.recInterval = setInterval(() => {
      state.recSeconds++;
      // Auto-stop at 5 minutes
      if (state.recSeconds >= 300) stopRecording();
      else render();
    }, 1000);

    render();

  } catch (err) {
    state.error = err.name === 'NotAllowedError'
      ? 'Microphone permission denied. Please allow microphone access and try again.'
      : 'Could not access microphone: ' + err.message;
    render();
  }
}

function stopRecording() {
  if (state.mediaRecorder && state.isRecording) {
    state.mediaRecorder.stop();
    state.isRecording = false;
    clearInterval(state.recInterval);
  }
}

function clearRecording() {
  state.audioBlob = null;
  state.audioURL  = null;
  state.recSeconds = 0;
  state.isRecording = false;
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE UPLOAD LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) setAudioFile(file);
}

function handleDragOver(e) {
  e.preventDefault();
  document.getElementById('uploadZone')?.classList.add('dragover');
}

function handleDragLeave(e) {
  document.getElementById('uploadZone')?.classList.remove('dragover');
}

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('uploadZone')?.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('audio/')) {
    setAudioFile(file);
  } else {
    state.error = 'Please drop an audio file (MP3, WAV, M4A, OGG).';
    render();
  }
}

function setAudioFile(file) {
  if (file.size > 25 * 1024 * 1024) {
    state.error = 'File too large. Maximum size is 25MB (Groq Whisper limit).';
    render();
    return;
  }
  state.audioFile = file;
  state.audioURL  = URL.createObjectURL(file);
  state.error     = '';
  render();
}

function clearFile() {
  state.audioFile = null;
  state.audioURL  = null;
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSCRIPTION â€” Groq Whisper API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function transcribeAudio(audioBlob, filename = 'audio.webm') {
  // Groq Whisper uses multipart/form-data (different from chat completions)
  const formData = new FormData();
  formData.append('file', audioBlob, filename);
  formData.append('model', 'whisper-large-v3');  // Groq's Whisper model
  formData.append('response_format', 'text');     // Just return text
  formData.append('language', 'en');              // Set to 'hi' for Hindi, 'ta' for Tamil

  const response = await fetch(
    'https://api.groq.com/openai/v1/audio/transcriptions',
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${state.apiKey}`,
        // NOTE: Do NOT set Content-Type â€” browser sets it automatically with boundary
      },
      body: formData,
    }
  );

  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    throw new Error(err.error?.message || `Transcription failed: ${response.status}`);
  }

  // Response is plain text when response_format is 'text'
  const transcript = await response.text();
  return transcript.trim();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLAG ANALYSIS â€” Groq Llama API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function analyzeText(text) {
  const modeNote =
    state.analyzeMode === 'red'
      ? '\n\nFocus ONLY on red flags. Return empty array [] for green_flags.'
    : state.analyzeMode === 'green'
      ? '\n\nFocus ONLY on green flags. Return empty array [] for red_flags.'
    : '';

  const response = await fetch(
    'https://api.groq.com/openai/v1/chat/completions',
    {
      method: 'POST',
      headers: {
        'Content-Type':  'application/json',
        'Authorization': `Bearer ${state.apiKey}`,
      },
      body: JSON.stringify({
        model:       'llama-3.3-70b-versatile',
        max_tokens:  1400,
        temperature: 0.2,
        messages: [
          { role: 'system', content: SYSTEM_PROMPT + modeNote },
          { role: 'user',   content: `Analyze this for relationship flags:\n\n${text}` },
        ],
      }),
    }
  );

  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    if (response.status === 401) throw new Error('Invalid API key. Please re-enter your Groq key.');
    if (response.status === 429) throw new Error('Rate limit reached. Please wait a moment.');
    throw new Error(err.error?.message || `API error ${response.status}`);
  }

  const data     = await response.json();
  const rawText  = data.choices?.[0]?.message?.content || '';
  const clean    = rawText.replace(/```json|```/g, '').trim();
  return JSON.parse(clean);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN ANALYSIS FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startAnalysis() {
  state.error = '';

  // Validate
  if (state.inputMode === 'text' && !state.textInput.trim()) {
    state.error = 'Please enter a message to analyze.';
    render(); return;
  }
  if (state.inputMode === 'record' && !state.audioBlob) {
    state.error = 'Please record a voice note first.';
    render(); return;
  }
  if (state.inputMode === 'upload' && !state.audioFile) {
    state.error = 'Please upload an audio file first.';
    render(); return;
  }
  if (!state.apiKey) {
    state.screen = 'setup'; render(); return;
  }

  // Show loading
  state.screen = 'loading';
  render();

  try {
    let textToAnalyze = '';

    if (state.inputMode === 'text') {
      // Direct text analysis
      textToAnalyze = state.textInput;

    } else if (state.inputMode === 'record') {
      // Step 1: Transcribe recorded audio
      state.transcript = await transcribeAudio(state.audioBlob, 'recording.webm');
      textToAnalyze    = state.transcript;

    } else if (state.inputMode === 'upload') {
      // Step 1: Transcribe uploaded file
      state.transcript = await transcribeAudio(state.audioFile, state.audioFile.name);
      textToAnalyze    = state.transcript;
    }

    if (!textToAnalyze || textToAnalyze.length < 5) {
      throw new Error('Could not transcribe audio â€” the recording may be too short or silent.');
    }

    // Step 2: Analyze text for flags
    state.result = await analyzeText(textToAnalyze);
    state.screen = 'result';
    render();
    window.scrollTo({ top: 0, behavior: 'smooth' });

  } catch (err) {
    state.screen = 'analyze';
    state.error  = err.message.includes('JSON')
      ? 'Analysis error â€” please try again.'
      : (err.message || 'Something went wrong. Check your API key and try again.');
    render();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function attachEvents() {
  const msgInput = document.getElementById('msgInput');
  if (msgInput) msgInput.addEventListener('input', e => { state.textInput = e.target.value; });
  const keyInput = document.getElementById('apiKeyInput');
  if (keyInput) keyInput.addEventListener('input', e => { state.apiKey = e.target.value.trim(); });
}

function saveKey() {
  const inp = document.getElementById('apiKeyInput');
  if (inp && inp.value.trim()) {
    state.apiKey = inp.value.trim();
    localStorage.setItem('groq_key', state.apiKey);
    state.screen = 'analyze';
    render();
    window.scrollTo({ top:0, behavior:'smooth' });
  }
}

function setInputMode(mode) {
  state.inputMode = mode;
  state.error = '';
  render();
}

function setAnalyzeMode(mode) { state.analyzeMode = mode; render(); }
function setSample(i)  { state.textInput = SAMPLES[i]; render(); }
function clearText()   { state.textInput = ''; render(); }
function goSetup()     { state.screen = 'setup'; render(); }

function resetApp() {
  state.screen     = 'analyze';
  state.textInput  = '';
  state.audioBlob  = null;
  state.audioFile  = null;
  state.audioURL   = null;
  state.transcript = '';
  state.result     = null;
  state.error      = '';
  state.isRecording = false;
  clearInterval(state.recInterval);
  render();
  window.scrollTo({ top:0, behavior:'smooth' });
}

function esc(s) {
  return String(s||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
render();
</script>
</body>
</html>
```

---

## ğŸ¤ How to Use the Voice Features

### Recording a voice note:
```
1. Click the "ğŸ¤ Record" tab
2. Click the red mic button â†’ allow microphone access
3. Speak the conversation or describe the situation
4. Click the button again to stop
5. You'll see a playback bar â€” listen back to confirm
6. Click "Analyze Relationship Flags"
7. AI transcribes it first â†’ then detects flags!
```

### Uploading an audio file:
```
1. Click the "ğŸ“ Upload" tab
2. Drag and drop your file OR click to browse
3. Supports: MP3, WAV, M4A, OGG, WEBM
4. Works with WhatsApp voice notes!
   (Go to WhatsApp â†’ hold voice note â†’ Export â†’ save the file)
5. Click "Analyze Relationship Flags"